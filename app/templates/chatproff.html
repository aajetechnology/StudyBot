{% extends "base.html" %}
{% block title %}Office Hours{% endblock %}

{% block content %}
<div class="container py-3 h-100 d-flex flex-column" style="max-height: 90vh;">
    <div class="d-flex align-items-center mb-3 px-2">
        <div class="position-relative">
            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                <i class="bi bi-person-workspace text-white fs-4"></i>
            </div>
            <span class="position-absolute bottom-0 end-0 badge border border-2 border-white rounded-circle bg-success p-1"><span class="visually-hidden">Online</span></span>
        </div>
        <div class="ms-3">
            <h6 class="fw-bold mb-0 text-tg">Professor StudAI</h6>
            <small class="text-success small">Online â€¢ Office Hours</small>
        </div>
    </div>

    <div id="chat-window" class="flex-grow-1 overflow-auto p-3 mb-3 rounded-4 shadow-inner" style="background: var(--tg-bg); display: flex; flex-direction: column; gap: 15px;">
        <div class="bubble professor">
            Hello! I'm your Professor. Based on your recent notes about <strong>"{{ lecture.title if lecture else 'your studies' }}"</strong>, how can I help you today?
        </div>
    </div>

    <div class="input-container p-2 bg-tg-card rounded-pill shadow-sm d-flex align-items-center border border-tg">
        <input type="text" id="student-msg" class="form-control border-0 bg-transparent shadow-none text-tg" placeholder="Ask a question..." autocomplete="off">
        <button class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" onclick="sendMessage()">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

<style>
    .shadow-inner { box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
    .text-tg { color: var(--tg-text); }
    .bg-tg-card { background: var(--tg-card); }
    .border-tg { border: 1px solid rgba(120,120,120,0.2) !important; }

    /* Bubble Styling */
    .bubble {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.4;
        position: relative;
    }
    .professor {
        align-self: flex-start;
        background: var(--tg-card);
        color: var(--tg-text);
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .student {
        align-self: flex-end;
        background: var(--tg-link);
        color: white;
        border-bottom-right-radius: 4px;
    }

    /* Animation */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .bubble { animation: fadeIn 0.3s ease forwards; }
</style>

<script>
function sendMessage() {
    const input = document.getElementById('student-msg');
    const window = document.getElementById('chat-window');
    const msg = input.value.trim();
    if (!msg) return;

    // Append Student Bubble
    window.innerHTML += `<div class="bubble student">${msg}</div>`;
    input.value = '';
    window.scrollTop = window.scrollHeight;

    // Loading indicator
    const loadingId = 'loading-' + Date.now();
    window.innerHTML += `<div class="bubble professor" id="${loadingId}"><span class="spinner-grow spinner-grow-sm"></span> Thinking...</div>`;

    fetch("{{ url_for('chatproff.chat_professor') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: msg})
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById(loadingId).innerText = data.answer;
        window.scrollTop = window.scrollHeight;
    })
    .catch(() => {
        document.getElementById(loadingId).innerText = "The Professor is currently offline.";
    });
}

// Allow "Enter" key to send
document.getElementById('student-msg').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>
{% endblock %}
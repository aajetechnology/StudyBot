{% extends "base.html" %}
{% block title %}Classroom: {{ module_title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1200px;">
    <div class="row g-4">
        
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 20px;">
                <div class="card-body p-4">
                    <h6 class="fw-bold text-uppercase text-muted small mb-4">Course Progress</h6>
                    <div class="progress mb-4" style="height: 8px;">
                        {% set progress = (step / total_steps * 100)|int %}
                        <div class="progress-bar bg-primary rounded-pill" style="width: {{ progress }}%"></div>
                    </div>
                    
                    <div class="syllabus-list">
                        {% for i in range(total_steps) %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                {% if i + 1 < step %}
                                    <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                {% elif i + 1 == step %}
                                    <i class="bi bi-play-circle-fill text-primary fs-5 shadow-sm"></i>
                                {% else %}
                                    <i class="bi bi-circle text-muted fs-5"></i>
                                {% endif %}
                            </div>
                            <div class="small {% if i + 1 == step %}fw-bold text-dark{% else %}text-muted{% endif %}">
                                Module {{ i + 1 }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4">
                <div class="card-header bg-white border-0 p-4 pb-0">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item small text-uppercase">Module {{ step }} of {{ total_steps }}</li>
                        </ol>
                    </nav>
                    <h3 class="fw-bold text-dark">{{ module_title }}</h3>
                </div>

                <div class="card-body p-4">
                    <div class="bg-light p-4 rounded-4 mb-4" style="line-height: 1.8; font-size: 1.1rem; color: #344767;">
                        {{ explanation | replace('\n', '<br>') | safe }}
                    </div>

                    <div class="d-flex flex-wrap gap-3">
                        {% if step < total_steps %}
                        <a href="{{ url_for('classroom.next_module') }}" class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm">
                            I Understand, Next Module <i class="bi bi-arrow-right ms-2"></i>
                        </a>
                        {% else %}
                        <a href="{{ url_for('classroom.classroom_selection') }}" class="btn btn-success rounded-pill px-4 py-2 fw-bold">
                            Course Completed! <i class="bi bi-trophy ms-2"></i>
                        </a>
                        {% endif %}
                        
                        <button class="btn btn-outline-dark rounded-pill px-4 py-2" data-bs-toggle="modal" data-bs-target="#questionModal">
                            <i class="bi bi-chat-dots me-2"></i>Ask a Question
                        </button>

                        <a href="{{ url_for('quiz.run_exam', lecture_id=lecture_id, count=5) }}" class="btn btn-warning rounded-pill px-4 py-2 fw-bold">
                            <i class="bi bi-lightning-fill me-2"></i>Quick Test
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="questionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 p-4">
                <h5 class="modal-title fw-bold"><i class="bi bi-question-circle text-primary me-2"></i>Ask Professor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 pt-0">
                <p class="text-muted small mb-3">Is something unclear? Ask me to explain it differently or give more examples.</p>
                <form id="tutorForm">
                    <input type="hidden" name="module_title" value="{{ module_title }}">
                    <textarea class="form-control rounded-4 border-light shadow-sm mb-3" name="question" rows="4" placeholder="e.g., 'Can you explain the last part with an example?'"></textarea>
                    <div id="tutorResponse" class="p-3 bg-primary bg-opacity-10 rounded-3 mb-3 d-none">
                        </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2" id="askBtn">
                        Ask Question
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('tutorForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('askBtn');
    const responseDiv = document.getElementById('tutorResponse');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Thinking...';

    const formData = new FormData(e.target);
    const res = await fetch("{{ url_for('classroom.ask_tutor') }}", {
        method: 'POST',
        body: formData
    });
    
    const data = await res.json();
    responseDiv.classList.remove('d-none');
    responseDiv.innerHTML = `<strong>Professor:</strong><br>${data.answer}`;
    
    btn.disabled = false;
    btn.innerHTML = 'Ask Question';
};
</script>

<style>
    body { background-color: #f8f9fa; }
    .breadcrumb-item + .breadcrumb-item::before { content: "â€¢"; }
    .sticky-top { z-index: 1000; }
</style>
{% endblock %}